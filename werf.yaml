---
project: mqtt-gateway
configVersion: 1
---
artifact: build-stage
from: erlang:21-alpine
git:
- add: /
  to: /app
  includePaths:
  - src
  stageDependencies:
    setup:
    - src/**
shell:
  beforeInstall:
  - set -xe
  - echo "http://dl-cdn.alpinelinux.org/alpine/v3.9/main" >> /etc/apk/repositories
  - apk add --update ca-certificates libcrypto1.1 curl perl git make
  setup:
  - cd /app
  - make app && make rel
---
image: app
from: foxford/vernemq:1.11.0
git:
- add: /docker
  to: /docker
  includePaths:
  - docker
  stageDependencies:
    setup:
    - docker/**
docker:
  ENV:
    TERM: "xterm"
    TZ: "Europe/Moscow"
  WORKDIR: /app
  USER: root
shell:
  beforeInstall:
  - mkdir -p /app/data/keys
import:
- artifact: build-stage
  add: /build/_rel/mqttgw
  to: /app/mqttgw
  before: setup
shell:
  beforeInstall:
  - set -xe
  - echo "http://dl-cdn.alpinelinux.org/alpine/v3.9/main" >> /etc/apk/repositories
  - apk add --update libcrypto1.1
  - mkdir /etc/vernemq
  setup:
  - cp docker/vernemq.conf /vernemq/etc/vernemq.conf
  - sed -i.bak -r "s/-name VerneMQ@.+/-name $(cat /vernemq/etc/vernemq.conf | grep nodename | awk -F ' = ' '{print $2}')/" /vernemq/etc/vm.args
